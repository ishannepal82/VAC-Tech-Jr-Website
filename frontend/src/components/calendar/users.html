<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <title>Calendar â€” Events</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="users.css">
</head>
<body>
    <div class="window">
        <div class="title-bar">
            <div class="dot red"></div><div class="dot yellow"></div><div class="dot green"></div>
        </div>
        <div class="app-wrapper">
            <button class="hamburger" id="toggleSidebar" title="Toggle sidebar">
                <svg viewBox="0 0 24 24" fill="none" stroke-width="2.5" stroke-linecap="round"><path d="M3 12h18M3 6h18M3 18h18"/></svg>
            </button>
            <button class="panel-toggle" id="toggleRight" title="Toggle event panel">
                <svg fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M9 5l7 7-7 7" /></svg>
            </button>

            <div class="app" id="appGrid">
                <aside class="sidebar">
                    <div class="sidebar-content">
                        <div class="year-row">
                            <button class="ybtn-prev" id="prevYear">&lt;</button>
                            <div class="year-label" id="yearLabel">2024</div>
                            <button class="ybtn-next" id="nextYear">&gt;</button>
                        </div>
                        <ul class="months" id="monthList"></ul>
                    </div>
                </aside>
                <section class="calendar">
                    <p class="calendar-description">A quick overview of your upcoming events and schedules.</p>
                    <div class="month-title" id="monthTitle">OCTOBER</div>
                    <div class="dow">
                        <div>Sun</div><div>Mon</div><div>Tue</div><div>Wed</div><div>Thu</div><div>Fri</div><div>Sat</div>
                    </div>
                    <div class="grid" id="grid"></div>
                </section>
                <section class="events">
                    <div class="events-content">
                        <div class="e-title" id="eventsTitle">UPCOMING EVENTS</div>
                        <div class="elist" id="eventList">
                            <div class="no-events">Loading events...</div>
                        </div>
                    </div>
                </section>
            </div>
        </div>
    </div>

    <script>
        const $ = (selector) => document.querySelector(selector);
        const $$ = (selector) => document.querySelectorAll(selector);
        
        const monthNames = ["January","February","March","April","May","June","July","August","September","October","November","December"];
        const API_BASE_URL = 'http://localhost:5000/api';

        const state = {
            viewYear: 2024,
            viewMonth: 9, // October
            selected: new Date(2024, 9, 11),
            events: {},
            ui: {
                leftCollapsed: false,
                rightCollapsed: false
            }
        };

        // DOM Elements
        const elements = {
            appGrid: $('#appGrid'),
            yearLabel: $('#yearLabel'),
            monthList: $('#monthList'),
            prevYear: $('#prevYear'),
            nextYear: $('#nextYear'),
            grid: $('#grid'),
            eventsTitle: $('#eventsTitle'),
            eventList: $('#eventList'),
            monthTitle: $('#monthTitle')
        };

        // --- API FUNCTIONS ---
        const api = {
            async getEvents() {
                try {
                    const response = await fetch(`${API_BASE_URL}/events`);
                    if (!response.ok) throw new Error('Failed to fetch events');
                    return await response.json();
                } catch (error) {
                    console.error('Error fetching events:', error);
                    throw error;
                }
            }
        };

        // --- UTILS ---
        const keyFromDate = (date) => {
            return `${date.getFullYear()}-${String(date.getMonth()+1).padStart(2,'0')}-${String(date.getDate()).padStart(2,'0')}`;
        };

        const loadState = async () => {
            try {
                elements.eventList.innerHTML = '<div class="no-events">Loading events...</div>';
                state.events = await api.getEvents();
            } catch (error) {
                elements.eventList.innerHTML = `
                    <div class="error-message">
                        Failed to load events. Please check if the server is running.
                    </div>
                `;
                console.error('Failed to load state:', error);
            }
        };

        // --- RENDER FUNCTIONS ---
        const render = () => {
            renderSidebar();
            renderCalendar();
            renderEventsPanel();
            applyUICollapse();
        };

        const applyUICollapse = () => {
            elements.appGrid.classList.toggle('left-collapsed', state.ui.leftCollapsed);
            elements.appGrid.classList.toggle('right-collapsed', state.ui.rightCollapsed);
        };

        const renderSidebar = () => {
            elements.yearLabel.textContent = state.viewYear;
            elements.monthList.innerHTML = monthNames.map((m, i) => 
                `<li class="${i === state.viewMonth ? 'active' : ''}" data-month="${i}">${m}</li>`
            ).join('');
        };

        const renderCalendar = () => {
            const y = state.viewYear, m = state.viewMonth;
            elements.monthTitle.textContent = monthNames[m].toUpperCase();
            
            const firstDay = new Date(y, m, 1).getDay();
            const daysInMonth = new Date(y, m + 1, 0).getDate();
            
            let cells = Array(firstDay).fill('<div class="cell empty"></div>');
            
            for (let d = 1; d <= daysInMonth; d++) {
                const date = new Date(y, m, d);
                const key = keyFromDate(date);
                const isSelected = date.toDateString() === state.selected.toDateString();
                const events = state.events[key] || [];
                const dots = events.slice(0, 2).map(e => 
                    `<div class="dot-s ${e.color}"></div>`
                ).join('');
                
                cells.push(`
                    <div class="cell ${isSelected ? 'selected' : ''}" data-day="${d}">
                        <div class="daynum">${d}</div>
                        <div class="dots">${dots}</div>
                    </div>
                `);
            }
            
            elements.grid.innerHTML = cells.join('');
        };

        const renderEventsPanel = () => {
            const key = keyFromDate(state.selected);
            const events = state.events[key] || [];

            if (!events.length) {
                elements.eventList.innerHTML = `<div class="no-events">No events for this day.</div>`;
                return;
            }

            elements.eventList.innerHTML = events.map(ev => `
                <div class="item">
                    <div class="bullet ${ev.color}"></div>
                    <div class="content">
                        <div class="name">${ev.title}</div>
                        <div class="desc">${ev.desc || ev.description}</div>
                    </div>
                </div>
            `).join('');
        };

        // --- EVENT LISTENERS ---
        elements.prevYear.addEventListener('click', () => {
            state.viewYear--;
            render();
        });

        elements.nextYear.addEventListener('click', () => {
            state.viewYear++;
            render();
        });

        elements.monthList.addEventListener('click', (e) => {
            if (e.target.dataset.month) {
                state.viewMonth = parseInt(e.target.dataset.month, 10);
                state.selected = new Date(state.viewYear, state.viewMonth, 1);
                render();
            }
        });

        elements.grid.addEventListener('click', (e) => {
            const cell = e.target.closest('.cell');
            if (cell && cell.dataset.day) {
                state.selected = new Date(state.viewYear, state.viewMonth, parseInt(cell.dataset.day, 10));
                render();
            }
        });

        $('#toggleSidebar').addEventListener('click', () => {
            state.ui.leftCollapsed = !state.ui.leftCollapsed;
            render();
        });

        $('#toggleRight').addEventListener('click', () => {
            state.ui.rightCollapsed = !state.ui.rightCollapsed;
            render();
        });

        // --- INIT ---
        const init = async () => {
            await loadState();
            render();
            
            // Refresh events every 30 seconds
            setInterval(async () => {
                await loadState();
                render();
            }, 30000);
        };

        init();
    </script>
</body>
</html>